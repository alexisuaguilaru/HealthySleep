x-common-database: &database_service
    container_name: database
    image: postgres:16.10-alpine

    environment:
        POSTGRES_DB: ${POSTGRES_DB}
        POSTGRES_USER: ${POSTGRES_USER}
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
        API_DB_USER: ${API_DB_USER}
        API_DB_PASSWORD: ${API_DB_PASSWORD}

    ports:
        - "5432:5432"

    volumes:
        - DataInference:/var/lib/postgresql/data
        - ./Database:/docker-entrypoint-initdb.d:ro

x-common-marimo-analysis-prod: &analysis_prod
    build:
        context: ./StatisticalAnalysis
        dockerfile: Dockerfile
        
    environment:
        DOMAIN: "https://${DOMAIN}"
        STATISTICAL_ANALYSIS_URL: "https://${STATISTICAL_ANALYSIS_URL}"
        DATA_MINING_URL: "https://${DATA_MINING_URL}"
    
    volumes:
        - ./Datasets:/Analysis/Datasets
        - ./StatisticalAnalysis:/Analysis/StatisticalAnalysis

    networks:
        - traefik_proxy

x-common-marimo-analysis-dev: &analysis_dev
    build:
        context: ./StatisticalAnalysis
        dockerfile: Dockerfile
        
    environment:
        DOMAIN: "http://localhost:8080"
        STATISTICAL_ANALYSIS_URL: "http://localhost:5050"
        DATA_MINING_URL: "http://localhost:5151"
    
    volumes:
        - ./Datasets:/Analysis/Datasets
        - ./StatisticalAnalysis:/Analysis/StatisticalAnalysis

x-common-api: &api_service
    container_name: api
    build:
        context: ./ModelAPI
        dockerfile: Dockerfile

    environment:
        DB_HOST: database
        DB_PORT: 5432
        POSTGRES_DB: ${POSTGRES_DB}
        API_DB_USER: ${API_DB_USER}
        API_DB_PASSWORD: ${API_DB_PASSWORD}
        DOMAIN: "https://${DOMAIN}"

    ports:
        - "8000:8000"

x-common-frontend: &frontend_service
    container_name: frontend

    ports:
        - "8080:8080"

services:
    database-dev:
        profiles: ["dev"]

        <<: *database_service

    database-prod:
        profiles: ["prod"]

        <<: *database_service

        networks:
            - internal_backend

    statistical-analysis-dev:
        profiles: ["dev"]

        container_name: statistical-analysis
        <<: *analysis_dev

        ports:
            - "5050:8282"
        
        command: marimo edit --no-token --host 0.0.0.0 -p 8282 StatisticalAnalysis/StatisticalAnalysis.py

    data-mining-dev:
        profiles: ["dev"]

        container_name: data-mining
        <<: *analysis_dev

        ports:
            - "5151:8181"
        
        command: marimo edit --no-token --host 0.0.0.0 -p 8181 StatisticalAnalysis/DataMining.py

    statistical-analysis-prod:
        profiles: ["prod"]

        container_name: statistical-analysis
        <<: *analysis_prod

        ports:
            - "5050:8282"
        
        command: marimo run --host 0.0.0.0 -p 8282 StatisticalAnalysis/StatisticalAnalysis.py

        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.statistical-analysis.rule=Host(`${DOMAIN}`) && PathPrefix(`/StatisticalAnalysis`)"
            - "traefik.http.routers.statistical-analysis.entrypoints=https"
            - "traefik.http.routers.statistical-analysis.tls.certresolver=cloudflare"
            - "traefik.http.services.statistical-analysis.loadbalancer.server.port=8282"

            - "traefik.http.routers.statistical-analysis.middlewares=eda-redirect@docker,eda-stripprefix@docker"

            - "traefik.http.routers.statistical-analysis.middlewares=eda-redirect@docker,eda-stripprefix@docker"

            - "traefik.http.middlewares.eda-redirect.redirectregex.regex=/(StatisticalAnalysis)$$"
            - "traefik.http.middlewares.eda-redirect.redirectregex.replacement=/$${1}/"
            - "traefik.http.middlewares.eda-redirect.redirectregex.permanent=true"

            - "traefik.http.middlewares.eda-stripprefix.stripprefix.prefixes=/StatisticalAnalysis"

    data-mining-prod:
        profiles: ["prod"]

        container_name: data-mining
        <<: *analysis_prod

        ports:
            - "5151:8181"
        
        command: marimo run --host 0.0.0.0 -p 8181 StatisticalAnalysis/DataMining.py

        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.data-mining.rule=Host(`${DOMAIN}`) && PathPrefix(`/DataMining`)"
            - "traefik.http.routers.data-mining.entrypoints=https"
            - "traefik.http.routers.data-mining.tls.certresolver=cloudflare"
            - "traefik.http.services.data-mining.loadbalancer.server.port=8181"

            - "traefik.http.routers.data-mining.middlewares=dm-redirect@docker,dm-stripprefix@docker"

            - "traefik.http.middlewares.dm-redirect.redirectregex.regex=/(DataMining)$$"
            - "traefik.http.middlewares.dm-redirect.redirectregex.replacement=/$${1}/"
            - "traefik.http.middlewares.dm-redirect.redirectregex.permanent=true"

            - "traefik.http.middlewares.dm-stripprefix.stripprefix.prefixes=/DataMining"

    api-dev:
        profiles: ["dev"]

        <<: *api_service

        depends_on:
            - database-dev
    
    api-prod:
        profiles: ["prod"]

        <<: *api_service

        depends_on:
            - database-prod

        networks:
            - internal_backend
            - traefik_proxy

        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.api.rule=Host(`${DOMAIN}`) && PathPrefix(`/api`) && (Method(`POST`) || Method(`OPTIONS`))"
            - "traefik.http.routers.api.entrypoints=https"
            - "traefik.http.routers.api.tls.certresolver=cloudflare"
            - "traefik.http.services.api.loadbalancer.server.port=8000"

    frontend-dev:
        profiles: ["dev"]

        <<: *frontend_service

        build:
            context: ./Frontend
            dockerfile: Dockerfile
            args:
                VITE_DOMAIN_URL: "http://localhost:8080"
                VITE_API_URL: "http://localhost:8000/api"
                VITE_STATISTICAL_ANALYSIS_URL: "http://localhost:5050"
                VITE_DATA_MINING_URL: "http://localhost:5151"

        depends_on:
            - api-dev
    
    frontend-prod:
        profiles: ["prod"]

        <<: *frontend_service

        build:
            context: ./Frontend
            dockerfile: Dockerfile
            args:
                VITE_DOMAIN_URL: "https://${DOMAIN}"
                VITE_API_URL: "https://${API_URL}"
                VITE_STATISTICAL_ANALYSIS_URL: "https://${STATISTICAL_ANALYSIS_URL}"
                VITE_DATA_MINING_URL: "https://${DATA_MINING_URL}"

        depends_on:
            - api-prod

        networks:
            - traefik_proxy

        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.frontend.rule=Host(`${DOMAIN}`)"
            - "traefik.http.routers.frontend.entrypoints=https"
            - "traefik.http.routers.frontend.tls.certresolver=cloudflare"
            - "traefik.http.services.frontend.loadbalancer.server.port=8080"

volumes:
    DataInference: 

networks:
    traefik_proxy:
        external: true
    internal_backend: